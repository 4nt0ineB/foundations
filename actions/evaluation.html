<!DOCTYPE html>
<html>
<head>
  <title>Evaluation</title>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="../style.css"/>
</head>
<body>
<textarea id="source">

background-image: url(../img/fp-tower/website-background.svg)

class: center, middle, white

.title[Evaluation]

---
# 1. Vals

.forty-seven-left[
```scala
val city = "New York"
// city: String = "New York"

val counter = 1
// counter: Int = 1
```
]

---
# 1. Vals are evaluated when created

.forty-seven-left[
```scala
val city = "New York".drop(4)
// city: String = "York"

val counter = 1 + 3
// counter: Int = 4
```
]

---
# 1. Vals are evaluated only once

.fifty-two-left[
```scala
import java.time.Instant

val nowSeconds = Instant.now().getEpochSecond
// nowSeconds: Long = 1616594266L
```
]


<br><br><br><br><br><br><br>

.fifty-two-left[
```scala
nowSeconds
// res: Long = 1616594266L

nowSeconds
// res: Long = 1616594266L
```
]

---
# 2. Defs

.forty-seven-left[
```scala
def greeting(): Unit =
  println("Hello")
```
]

---
# 2. Defs are evaluated when called

.forty-seven-left[
```scala
def greeting(): Unit =
  println("Hello")
```
]

<br><br><br><br>

.forty-seven-left[
```scala
greeting()
// Hello
```
]

---
# 2. Defs are reevaluated everytime

.forty-seven-left[
```scala
def greeting(): Unit =
  println("Hello")
```
]

<br><br><br><br>

.forty-seven-left[
```scala
greeting()
// Hello

greeting()
// Hello
```
]

---
# 2. Defs are reevaluated everytime

.forty-seven-left[
```scala
import java.time.Instant

def nowMillis(): Long =
  Instant.now().toEpochMilli
```
]

<br><br><br><br><br><br><br>

.forty-seven-left[
```scala
nowMillis()
// res: Long = 1616590118552L

nowMillis()
// res: Long = 1616590118554L
```
]

---
# 2. Defs without parameter

.sixty-two-left[
```scala
def greeting(): Unit =
  println("Hello")

case class User(firstName: String, lastName: String) {
  def fullName: String =
    s"${firstName} ${lastName}"
}
```
]

--

.sixty-two-left[
```scala
greeting()
// Hello

User("John", "Doe").fullName
// res6: String = "John Doe"

User("John", "Doe").firstName
// res7: String = "John"
```
]

---
# 3. Lazy Vals

.forty-seven-left[
```scala
lazy val greeting = println("Hello")
```
]

---
# 3. Lazy Vals are evaluated when first accessed

.forty-seven-left[
```scala
lazy val greeting = println("Hello")
```

```scala
greeting
// Hello
```
]

---
# 3. Lazy Vals are cached for subsequent evaluations

.forty-seven-left[
```scala
lazy val greeting = println("Hello")
```

```scala
greeting
// Hello

greeting

greeting
```
]

---
# Lazy Val code generation in Scala 3

https://dotty.epfl.ch/docs/reference/changed-features/lazy-vals-init.html

---
# Evaluation

<br><br>

.cols[
.forty-five[
```scala
val greeting =
  println("Hello")
// Hello

greeting


greeting
&#x200B;
```

.center[
## Once when created
]
]

.ten[&nbsp;&nbsp;&nbsp;]

.forty-five[
```scala
lazy val greeting =
  println("Hello")


greeting
// Hello

greeting
&#x200B;
```
.center[
## Once when accessed
]
]

.ten[&nbsp;&nbsp;&nbsp;]

.forty-five[
```scala
def greeting() =
  println("Hello")


greeting()
// Hello

greeting()
// Hello
```
.center[
## Everytime it is called
]
]
]

---
# Test code evaluation

.seventy-two-left[
```scala
test("a lazy val is only evaluated when first accessed") {
  // ...
}
```
]


---
# Test code evaluation

.seventy-two-left[
```scala
test("a lazy val is only evaluated when first accessed") {
  var counter = 0

  lazy val action = counter += 1
}
```
]

---
# Test code evaluation

.seventy-two-left[
```scala
test("a lazy val is only evaluated when first accessed") {
  var counter = 0

  lazy val action = counter += 1
  assert(counter == 0)

  action
  assert(counter == 1)

  action
  assert(counter == 1)
}
```
]

---
# Test code evaluation

.seventy-two-left[
```scala
test("a def is evaluated every time it is called") {
  var counter = 0

  def action() = counter += 1
  assert(counter == 0)

  action()
  assert(counter == 1)

  action()
  assert(counter == 2)
}
```
]

---
# Parameters evaluation

.forty-seven-left[
```scala
def sum(x: Double, y: Double): Unit = {
  val result = x + y
  println("The sum is $result")
}
```

<br>

```scala
def getEdaBalance(): Double = {
  println("Eda")
  120.0
}

def getBobBalance(): Double = {
  println("Bob")
  35.0
}
```
]

.forty-seven-right[
```scala
sum(
  getEdaBalance(),
  getBobBalance()
)
```
]

---
# Parameters evaluation

.forty-seven-left[
```scala
def sum(x: Double, y: Double): Unit = {
  val result = x + y
  println("The sum is $result")
}
```

<br>

```scala
def getEdaBalance(): Double = {
  println("Eda")
  120.0
}

def getBobBalance(): Double = {
  println("Bob")
  35.0
}
```
]

.forty-seven-right[
```scala
sum(
  getEdaBalance(),
  getBobBalance()
)
// Eda
// Bob
// The sum is 155.0
```
]

---
# Parameters evaluation

.forty-seven-left[
```scala
def sum(x: Double, y: Double): Unit = {
  val result = x + y
  println("The sum is $result")
}
```

<br>

```scala
def getEdaBalance(): Double = {
  println("Eda")
  120.0
}

def getBobBalance(): Double = {
  println("Bob")
  35.0
}
```
]

.forty-seven-right[
```scala
val eda = getEdaBalance()
// Eda
val bob = getBobBalance()
// Bob

sum(
  eda,
  bob
)
// The sum is 155.0
```
]


---
# Parameters evaluation

.seventy-two-left[
```scala
def getOrElse[A](option: Option[A], fallback: A): A =
  option match {
    case Some(value) => value
    case None        => fallback
  }
```
]
--

.seventy-two-left[
```scala
getOrElse(Some("bob@gmail.com"), "support@fp-tower.com")
// res: String = "bob@gmail.com"

getOrElse(None                 , "support@fp-tower.com")
// res: String = "support@fp-tower.com"
```
]

---
# Parameters evaluation

.seventy-two-left[
```scala
def getOrElse[A](option: Option[A], fallback: A): A =
  option match {
    case Some(value) => value
    case None        => fallback
  }
```

```scala
getOrElse(
  Some("bob@gmail.com"),
  throw new IllegalArgumentException("email is required")
)
// java.lang.IllegalArgumentException: email is required
```
]

---
# Parameters evaluation

.seventy-two-left[
```scala
def getOrElse[A](option: Option[A], fallback: () => A): A =
  option match {
    case Some(value) => value
    case None        => fallback()
  }
```
]

--


.forty-two-left[
## Def function
```scala
def greeting(): Unit =
  println("Hello")
```
]

.forty-seven-right[
## Val function
```scala
val greeting: () => Unit =
  () => println("Hello")
```
]

---
# Parameters evaluation

.seventy-two-left[
```scala
def getOrElse[A](option: Option[A], fallback: () => A): A =
  option match {
    case Some(value) => value
    case None        => fallback()
  }
```

```scala
getOrElse(
  Some("bob@gmail.com"),
  () => throw new IllegalArgumentException("email is required")
)
// res: String = "bob@gmail.com"

getOrElse(
  None,
  () => throw new IllegalArgumentException("email is required")
)
// java.lang.IllegalArgumentException: email is required
```
]

---
# By-name parameters

.seventy-two-left[
```scala
def getOrElse[A](option: Option[A], fallback: => A): A =
  option match {
    case Some(value) => value
    case None        => fallback
  }
```
]

---
# By-name parameters

.seventy-two-left[
```scala
def getOrElse[A](option: Option[A], fallback: => A): A =
  option match {
    case Some(value) => value
    case None        => fallback
  }
```

```scala
getOrElse(
  Some("bob@gmail.com"),
  throw new IllegalArgumentException("email is required")
)
// res: String = "bob@gmail.com"

getOrElse(
  None,
  throw new IllegalArgumentException("email is required")
)
// java.lang.IllegalArgumentException: email is required
```
]

---
# Test by-name parameters

.forty-seven-left[
```scala
sealed trait Eval

case object Never extends Eval
case object Once  extends Eval
case object Twice extends Eval

def testEval(eval: Eval, param: => Unit) =
  eval match {
    case Never => () // do nothing
    case Once  => param
    case Twice =>
      param
      param
  }
```
]

--

.forty-seven-right[
```scala
test("by-name parameter evaluation") {
  var counter = 0

  testEval(Never, counter += 1)
  assert(counter == 0)

  testEval(Once, counter += 1)
  assert(counter == 1)

  counter = 0 // reset counter
  testEval(Twice, counter += 1)
  assert(counter == 2)
}
&#x200B;
```
]


---
class: white

background-image: url(../img/fp-tower/website-background.svg)

<br><br>
# .white[Three types of expression evaluation]

.thirty-seven-left[
## .white[Once when defined]

## .white[Once when first accessed]

## .white[Everytime called]
]

.sixty-two-right[
## .white[→ `val`]

## .white[→ `lazy val`]

## .white[→ `def`]
]

---
class: white

background-image: url(../img/fp-tower/website-background.svg)

<br><br>
# .white[Two types of parameters evaluation]

.twenty-seven-left[
## .white[Standard (by-value)]

## .white[By-name]
]

.seventy-two-right[
## .white[behaves like `val`]

## .white[behaves like `def`]
]

---
class: white

background-image: url(../img/fp-tower/website-background.svg)
<br>
# .white[Summary]

<br>

## .white[Three types of evaluation:]

## .white[1.] .white[val - once when created]

## .white[2.] .white[lazy val - once when first created]

## .white[3.] .white[Faster to onboard developers]


---
# Retry

.fifty-seven-left[
```scala
def retry[A](maxAttempt: Int, action: => A): A =
  ???
```
]


---
# Parameters evaluation

.sixty-two-left[
```scala
def getOrElse[A](option: Option[A], fallback: => A): A =
  option match {
    case Some(value) => value
    case None        => fallback
  }
```

```scala
getOrElse(Some(1), 5)
// res29: Int = 1

getOrElse(None, 5)
// res30: Int = 5
```

```scala
getOrElse(Some(1), sys.error("Must be defined"))
// res31: Int = 1
```
]




---
# Retry

.seventy-seven-left[
```scala
import java.time.LocalDate

def readSubscribe  (console: Console, maxAttempt: Int): Boolean =
  ???

def readDateOfBirth(console: Console, maxAttempt: Int): LocalDate =
  ???
```
]

--

.seventy-seven-left[
```scala
def retry(console: Console, maxAttempt: Int) =
  ???
```
]


---
# Exceptions

<br><br>

.cols[
.forty-five[
```scala
val greeting = ???
// NotImplementedError
```
]

.ten[&nbsp;&nbsp;&nbsp;]

.forty-five[
```scala
lazy val greeting = ???
&#x200B;
```
]

.ten[&nbsp;&nbsp;&nbsp;]

.forty-five[
```scala
def greeting(): Int = ???
&#x200B;
```
]
]

---
# Evaluation

.cols[


.forty-five[
```scala
val user: Option[User] =
  fetchUser(1234)
// Some(User("Bob", ...))

user
// Some(User("Bob", ...))

user
// Some(User("Bob", ...))
```
]

.ten[&nbsp;&nbsp;]

.forty-five[
```scala
lazy val user: Option[User] =
  fetchUser(1234)


user
// Some(User("Bob", ...))

user
// Some(User("Bob", ...))
```
]

.ten[&nbsp;&nbsp;]

.forty-five[
```scala
def user(): Option[User] =
  fetchUser(1234)


user()
// Some(User("Bob", ...))

user()
// None
```
]
]

---
# Retry

```scala
def retry[A](maxAttempt: Int): A = {
  var result   : Option[A] = None
  var remaining: Int       = maxAttempt

  while (result.isEmpty && remaining > 0) {
    remaining -= 1
    state = Try { ... }.toOption
  }

  result.getOrElse(sys.error(s"Failed after $maxAttempt attempts"))
}
```

---
# def vs val

.forty-seven-left[
```scala
def execDef: Int = {
  println("Hello")
  5
}



execDef
// Hello
// res32: Int = 5

execDef
// Hello
// res33: Int = 5
```
]

.forty-seven-right[
```scala
val execVal: Int = {
  println("Hello")
  5
}
// Hello
// execVal: Int = 5

execVal
// res34: Int = 5

execVal
// res35: Int = 5
```
]

---
# Methods without parameters

.forty-seven-left[
```scala
case class User(
  firstName: String,
  lastName: String,
  age: Int
) {
  def fullName: String =
    s"$firstName $lastName"
}

val eda = User("Eda", "Smith", 45)
```

```scala
eda.`firstName`
// res36: String = "Eda"

eda.`fullName`
// res37: String = "Eda Smith"
```
]

---
# def vs val

.forty-seven-left[
```scala
def execDef(): Int = {
  println("Hello")
  5
}



execDef()
// Hello
// res39: Int = 5

execDef()
// Hello
// res40: Int = 5
```
]

.forty-seven-right[
```scala
val execVal: Int = {
  println("Hello")
  5
}
// Hello
// execVal: Int = 5

execVal
// res41: Int = 5

execVal
// res42: Int = 5
```
]

---
# lazy val vs val

.forty-seven-left[
```scala
lazy val execLazyVal: Int = {
  println("Hello")
  5
}



execLazyVal
// Hello
// res44: Int = 5

execLazyVal
// res45: Int = 5
```
]

.forty-seven-right[
```scala
val execVal: Int = {
  println("Hello")
  5
}
// Hello
// execVal: Int = 5

execVal
// res46: Int = 5

execVal
// res47: Int = 5
```
]

---
# Execution

<br>

.forty-two-left[
## 1. Execute everytime

## 2. Execute once when first used

## 3. Execute once when defined
]

.fifty-two-right[
## -> `def`

## -> `lazy val`

## -> `val`
]

---
# Def vs Lazy Val vs Val

.cols[
.forty-five[
```scala
def exec(): Int = {
  println("Hello")
  5
}

exec()

exec()
```
]

.ten[&nbsp;&nbsp;&nbsp;&nbsp;]

.forty-five[
```scala
lazy val exec: Int = {
  println("Hello")
  5
}

exec

exec
```
]

.ten[&nbsp;&nbsp;&nbsp;&nbsp;]

.forty-five[
```scala
val exec: Int = {
  println("Hello")
  5
}

exec

exec
```
]
]

---
# def vs lazy val vs val

.cols[
.forty-five[
```scala
def exec(): Int = {
  println("Hello")
  5
}

exec()
// 5

exec()
// 5
```
]

.ten[&nbsp;&nbsp;&nbsp;&nbsp;]

.forty-five[
```scala
lazy val exec: Int = {
  println("Hello")
  5
}

exec
// 5

exec
// 5
```
]

.ten[&nbsp;&nbsp;&nbsp;&nbsp;]

.forty-five[
```scala
val exec: Int = {
  println("Hello")
  5
}

exec
// 5

exec
// 5
```
]
]

---
# def vs lazy val vs val

.cols[
.forty-five[
```scala
def exec(): Int = {
  println("Hello")
  5
}


exec()
// Hello

exec()
// Hello
```
.center[
## Every time it is called
]
]

.ten[&nbsp;&nbsp;&nbsp;&nbsp;]

.forty-five[
```scala
lazy val exec: Int = {
  println("Hello")
  5
}


exec
// Hello

exec
&#x200B;
```

.center[
## First time it is called
]
]

.ten[&nbsp;&nbsp;&nbsp;&nbsp;]

.forty-five[
```scala
val exec: Int = {
  println("Hello")
  5
}
// Hello

exec


exec
&#x200B;
```
.center[
## When it is defined
]
]
]

---
# Arguments evaluation

<br>

```scala
def foo(x: Int, y: Int): Int = x + y
```

.forty-seven-left[
```scala
foo(
  { println("Hello"); 4 },
  { println("World"); 2 },
)
// Hello
// World
// res48: Int = 6
```
]

--

.forty-seven-right[
```scala
val x = { println("Hello"); 4 }
// Hello

val y = { println("World"); 2 }
// World

foo(x, y)
// res: Int = 6
```
]

---
# Arguments evaluation

<br>

```scala
def foo(x: Int, y: Int): Int = x + y
```

.forty-seven-left[
```scala
foo(
  { println("Hello"); 4 },
  { println("World"); 2 },
)
// Hello
// World
// res50: Int = 6
```
]


.forty-seven-right[
```scala
println("Hello")
// Hello
val x = 4

println("World")
// World
val y = 2

foo(x, y)
// res: Int = 6
```
]

---
# Arguments evaluation

.sixty-seven-left[
```scala
def repeat(iteration: Int, block: () => Int): List[Int] =
  1.to(iteration).map(_ =>
    block()
  )
```
]

</textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>
    var slideshow = remark.create({
        ratio: "16:9",
        slideNumberFormat: '',
        highlightLines: true,
        highlightSpans: true,
    });
</script>
</body>
</html>